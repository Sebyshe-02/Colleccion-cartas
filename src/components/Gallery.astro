---
import { getCollection } from "astro:content";
const assets = await getCollection("assets");
---

<div class="gallery">
    {assets && assets.length ? (
        assets.map(asset => (
            <img src={asset.data.secure_url} alt={asset.data.public_id} loading="lazy" />
        ))
    ) : (
        <p class="empty">No hay cartas para mostrar.</p>
    )}
    
</div>

<style>
    :global(.gallery) {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        width: 100%;
        padding: 20px;
    }

    :global(.gallery img), :global(.gallery-img) {
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease; 
    }

    :global(.gallery img:hover), :global(.gallery-img:hover) {
        transform: scale(1.05); 
    }

</style>

<script type="module">
    if (typeof window !== 'undefined') {
        const gallery = document.querySelector('.gallery');
        const empty = document.querySelector('.empty');

        async function refreshFromServer() {
            try {
                const res = await fetch('/api/assets');
                if (!res.ok) return;
                const resources = await res.json();
                if (!Array.isArray(resources)) return;
                if (gallery) gallery.innerHTML = '';
                if (resources.length === 0 && gallery) {
                    gallery.innerHTML = '<p class="empty">No hay cartas para mostrar.</p>';
                    return;
                }
                for (const r of resources) {
                    const img = document.createElement('img');
                    img.src = r.secure_url || r.url || '';
                    img.alt = r.public_id || 'Carta';
                    img.loading = 'lazy';
                    img.classList.add('gallery-img');
                    gallery.appendChild(img);
                }
            } catch (err) {
                console.error('Failed to fetch assets', err);
            }
        }

        // initial refresh to ensure latest assets are shown
        refreshFromServer();

        // when a new asset is uploaded, prepend it immediately and also refresh in background
        window.addEventListener('asset:added', (ev) => {
            const res = ev.detail;
            const src = res.secure_url || res.url || '';
            const img = document.createElement('img');
            img.src = src;
            img.alt = res.public_id || 'Carta';
            img.loading = 'lazy';
            img.classList.add('gallery-img');
            if (gallery) gallery.prepend(img);
            if (empty) empty.remove();
            // refresh in background to sync ordering and any missing metadata
            setTimeout(() => refreshFromServer(), 1000);
        });
    }
</script>
